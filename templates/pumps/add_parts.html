{% extends "base.html" %}

{% block content %}
<style>
  .table-responsive {
    overflow-x: auto;
  }
  th {
    white-space: nowrap;
    font-size: 0.9em;
  }
  td input, td select {
    min-width: 100px;
  }
  
  /* Part name column - wider with text wrap */
  .part-name-col {
    min-width: 250px;
    width: 35%;
  }
  .part-name {
    min-width: 250px !important;
    white-space: normal !important;
    word-wrap: break-word;
  }
  
  /* Narrower columns */
  .weight-col, .qty-col {
    width: 10%;
    min-width: 80px;
  }
  .brand-col, .material-col {
    width: 15%;
    min-width: 100px;
  }
  .action-col {
    width: 8%;
    min-width: 60px;
  }
  
  .weight-col input, .qty-col input {
    min-width: 80px !important;
  }
  .brand-col input, .material-col input {
    min-width: 100px !important;
  }
</style>

<h3>Add Parts ‚Äì {{ pump.name }}</h3>

<!-- Alert Box -->
<div id="alertBox" class="alert d-none" role="alert"></div>

{% if read_only %}
<div class="alert alert-secondary mt-2">
  üîí This pump is {{ pump.status }}. Parts cannot be edited.
</div>
{% endif %}

<div class="mb-3">
  <strong>Pump Type:</strong> <span class="badge bg-info">{{ pump.pump_type }}</span> | 
  <strong>Status:</strong> 
  <span class="badge {% if pump.status == 'PENDING' %}bg-warning{% else %}bg-success{% endif %}">
    {{ pump.status }}
  </span>
</div>

{% if pump.pump_type == 'OTHER' %}
<!-- Two column layout for OTHER pump type -->
<div class="row">
  <!-- OTHER Source Parts (Left) -->
  <div class="col-md-6">
    <h4 class="mt-2">OTHER Source Parts</h4>
    <div class="table-responsive">
      <table class="table table-bordered table-sm" id="otherPartsTable">
        <thead class="table-light">
          <tr>
            <th class="part-name-col">Part Name</th>
            <th class="weight-col">Weight (kg)</th>
            <th class="qty-col">Qty</th>
            <th class="brand-col">Brand</th>
            <th class="material-col">Material</th>
            <th class="action-col">Action</th>
          </tr>
        </thead>
        <tbody id="otherPartsBody">
          <!-- Rows will be loaded dynamically -->
        </tbody>
      </table>
    </div>
    {% if not read_only %}
    <button class="btn btn-secondary btn-sm mb-3" onclick="addOtherPart()">+ Add OTHER Part</button>
    {% endif %}
  </div>

  <!-- VERSIL Source Parts (Right) -->
  <div class="col-md-6">
    <h4 class="mt-2">VERSIL Source Parts</h4>
    <div class="table-responsive">
      <table class="table table-bordered table-sm" id="versilPartsTable">
        <thead class="table-light">
          <tr>
            <th class="part-name-col">Part Name</th>
            <th class="weight-col">Weight (kg)</th>
            <th class="qty-col">Qty</th>
            <th class="brand-col">Brand</th>
            <th class="material-col">Material</th>
            <th class="action-col">Action</th>
          </tr>
        </thead>
        <tbody id="versilPartsBody">
          <!-- Rows will be loaded dynamically -->
        </tbody>
      </table>
    </div>
    {% if not read_only %}
    <button class="btn btn-secondary btn-sm mb-3" onclick="addVersilPart()">+ Add VERSIL Part</button>
    {% endif %}
  </div>
</div>

{% elif pump.pump_type == 'VERSIL' %}
<!-- Single column layout for VERSIL pump type - only VERSIL parts -->
<h4 class="mt-4">VERSIL Source Parts</h4>
<div class="table-responsive">
  <table class="table table-bordered table-sm" id="versilPartsTable">
    <thead class="table-light">
      <tr>
        <th class="part-name-col">Part Name</th>
        <th class="weight-col">Weight (kg)</th>
        <th class="qty-col">Qty</th>
        <th class="brand-col">Brand</th>
        <th class="material-col">Material</th>
        <th class="action-col">Action</th>
      </tr>
    </thead>
    <tbody id="versilPartsBody">
      <!-- Rows will be loaded dynamically -->
    </tbody>
  </table>
</div>
{% if not read_only %}
<button class="btn btn-secondary btn-sm mb-3" onclick="addVersilPart()">+ Add VERSIL Part</button>
{% endif %}

{% endif %}

<div class="mt-4">
  {% if not read_only %}
  <button class="btn btn-primary" onclick="saveAllParts()">üíæ Save All Parts</button>
  {% endif %}
  <a href="{{ url_for('pump_management', pump_id = pump.id) }}" class="btn btn-secondary">‚Üê Back to Pump Forms</a>
</div>

<script>
const pumpId = {{ pump.id }};
const pumpType = "{{ pump.pump_type }}";
const readOnly = {{ 'true' if read_only else 'false' }};

// Load existing parts on page load
document.addEventListener('DOMContentLoaded', function() {
  loadParts();
});

async function loadParts() {
  try {
    const response = await fetch(`/api/pumps/${pumpId}/parts`);
    const data = await response.json();
    
    const otherParts = data.parts.filter(p => p.source === 'OTHER');
    const versilParts = data.parts.filter(p => p.source === 'VERSIL');
    
    // Clear existing rows
    if (pumpType === 'OTHER') {
      document.getElementById('otherPartsBody').innerHTML = '';
    }
    document.getElementById('versilPartsBody').innerHTML = '';
    
    // Add OTHER parts (only if pump type is OTHER)
    if (pumpType === 'OTHER') {
      otherParts.forEach(part => {
        addPartRow('OTHER', part);
      });
    }
    
    // Add VERSIL parts
    versilParts.forEach(part => {
      addPartRow('VERSIL', part);
    });
    
    // If no parts exist and not read-only, add empty rows
    if (!readOnly) {
      if (pumpType === 'OTHER' && otherParts.length === 0) {
        addPartRow('OTHER', null);
      }
      if (versilParts.length === 0) {
        addPartRow('VERSIL', null);
      }
    }
  } catch (error) {
    showAlert('Error loading parts: ' + error.message, 'danger');
  }
}

function addOtherPart() {
  addPartRow('OTHER', null);
}

function addVersilPart() {
  addPartRow('VERSIL', null);
}

function addPartRow(source, partData) {
  const tbody = source === 'OTHER' ? 
    document.getElementById('otherPartsBody') : 
    document.getElementById('versilPartsBody');
  
  const row = document.createElement('tr');
  row.dataset.partId = partData ? partData.id : '';
  row.dataset.source = source;
  
  const isReadOnly = readOnly ? 'readonly' : '';
  
  row.innerHTML = `
    <td class="part-name-col">
      <input type="text" class="form-control form-control-sm part-name" 
             value="${partData ? partData.part_name : ''}" 
             ${isReadOnly}>
    </td>
    <td class="weight-col">
      <input type="number" step="0.01" class="form-control form-control-sm part-weight" 
             value="${partData ? partData.weight : ''}" 
             ${isReadOnly}>
    </td>
    <td class="qty-col">
      <input type="number" class="form-control form-control-sm part-qty" 
             value="${partData ? partData.quantity : ''}" 
             ${isReadOnly}>
    </td>
    <td class="brand-col">
      <input type="text" class="form-control form-control-sm part-brand" 
             value="${partData ? partData.brand : ''}" 
             ${isReadOnly}>
    </td>
    <td class="material-col">
      <input type="text" class="form-control form-control-sm part-material" 
             value="${partData ? partData.material : ''}" 
             ${isReadOnly}>
    </td>
    <td class="action-col text-center">
      ${!readOnly ? `<button class="btn btn-danger btn-sm" onclick="deletePartRow(this)">√ó</button>` : ''}
    </td>
  `;
  
  tbody.appendChild(row);
}

function deletePartRow(button) {
  if (readOnly) return;
  
  const row = button.closest('tr');
  const partId = row.dataset.partId;
  
  if (!partId) {
    // Just remove the row if part hasn't been saved yet
    row.remove();
    return;
  }
  
  if (!confirm('Are you sure you want to delete this part?')) {
    return;
  }
  
  // Mark for deletion by adding a class
  row.classList.add('to-delete');
  row.style.opacity = '0.5';
  row.style.textDecoration = 'line-through';
  
  showAlert('Part marked for deletion. Click "Save All Parts" to confirm.', 'warning');
}

async function saveAllParts() {
  if (readOnly) {
    showAlert('Cannot save in read-only mode', 'warning');
    return;
  }
  
  try {
    // Collect all parts to save
    const allRows = document.querySelectorAll('#otherPartsBody tr, #versilPartsBody tr');
    let savedCount = 0;
    let deletedCount = 0;
    let errors = [];
    
    for (const row of allRows) {
      const partId = row.dataset.partId;
      const source = row.dataset.source;
      
      // Handle deletions
      if (row.classList.contains('to-delete')) {
        if (partId) {
          const deleteResponse = await fetch(`/api/pumps/${pumpId}/parts/${partId}`, {
            method: 'DELETE'
          });
          const deleteData = await deleteResponse.json();
          
          if (deleteData.success) {
            row.remove();
            deletedCount++;
          } else {
            errors.push(`Failed to delete part: ${deleteData.error}`);
          }
        }
        continue;
      }
      
      // Handle saves/updates
      const partName = row.querySelector('.part-name').value.trim();
      
      // Skip empty rows
      if (!partName) {
        if (partId) {
          // Delete part if it exists but name is now empty
          const deleteResponse = await fetch(`/api/pumps/${pumpId}/parts/${partId}`, {
            method: 'DELETE'
          });
          const deleteData = await deleteResponse.json();
          
          if (deleteData.success) {
            row.remove();
            deletedCount++;
          }
        } else {
          // Just remove empty unsaved row
          row.remove();
        }
        continue;
      }
      
      const partData = {
        id: partId || null,
        source: source,
        part_name: partName,
        weight: parseFloat(row.querySelector('.part-weight').value) || 0,
        quantity: parseInt(row.querySelector('.part-qty').value) || 0,
        brand: row.querySelector('.part-brand').value.trim(),
        material: row.querySelector('.part-material').value.trim()
      };
      
      const response = await fetch(`/api/pumps/${pumpId}/parts/save`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(partData)
      });
      
      const data = await response.json();
      
      if (data.success) {
        // Update the row with the new part ID if it was just created
        if (!partId) {
          row.dataset.partId = data.id;
        }
        savedCount++;
      } else {
        errors.push(`Failed to save "${partName}": ${data.error}`);
      }
    }
    
    // Show results
    if (errors.length > 0) {
      showAlert(`Saved: ${savedCount}, Deleted: ${deletedCount}, Errors: ${errors.length}. Check console for details.`, 'warning');
      console.error('Save errors:', errors);
    } else if (savedCount > 0 || deletedCount > 0) {
      showAlert(`‚úì Successfully saved ${savedCount} part(s) and deleted ${deletedCount} part(s)`, 'success');
    } else {
      showAlert('No changes to save', 'info');
    }
    
  } catch (error) {
    showAlert('Error saving parts: ' + error.message, 'danger');
    console.error('Save error:', error);
  }
}

function showAlert(message, type) {
  const alertBox = document.getElementById('alertBox');
  alertBox.className = `alert alert-${type}`;
  alertBox.textContent = message;
  alertBox.classList.remove('d-none');
  
  setTimeout(() => {
    alertBox.classList.add('d-none');
  }, 5000);
}
</script>

{% endblock %}