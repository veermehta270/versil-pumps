{% extends "base.html" %}

{% block content %}
<style>
  .table-responsive {
    overflow-x: auto;
  }
  th {
    white-space: nowrap;
    font-size: 0.9em;
  }
  td input, td select {
    min-width: 150px;
  }
</style>

<h3>Testing Workflow ‚Äì {{ pump.name }}</h3>


<!-- Alert Box -->
<div id="alertBox" class="alert d-none" role="alert"></div>

{% if read_only %}
<div class="alert alert-secondary mt-2">
  üîí You have view-only access to this form.
</div>
{% endif %}

<div class="table-responsive">
  <table class="table table-bordered table-sm" id="workflowTable">
    <thead class="table-light">
      <tr>
        <th>Date</th>
        <th>User</th>
        <th>Action</th>
        <th>Remark</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody>
      {% if activities %}
        {% for activity in activities %}
        <tr data-readonly="true">
          <td>
            <input type="text" class="form-control form-control-sm workflow-date" 
                   value="{{ activity.date }}" readonly>
          </td>
          <td>
            <input type="text" class="form-control form-control-sm workflow-user" 
                   value="{{ activity.user.username }}" readonly>
          </td>
          <td>
            <select class="form-select form-select-sm workflow-action" disabled>
              <option value="Assembly" {% if activity.action == 'Assembly' %}selected{% endif %}>Assembly</option>
              <option value="Testing" {% if activity.action == 'Testing' %}selected{% endif %}>Testing</option>
              <option value="Testing Report Date" {% if activity.action == 'Testing Report Date' %}selected{% endif %}>Testing Report Date</option>
              <option value="Rejected by Boss" {% if activity.action == 'Rejected by Boss' %}selected{% endif %}>Rejected by Boss</option>
            </select>
          </td>
          <td>
            <input type="text" class="form-control form-control-sm workflow-remark" 
                   value="{{ activity.remark or '' }}" readonly>
          </td>
          <td class="text-center">
            <button class="btn btn-secondary btn-sm" disabled>√ó</button>
          </td>
        </tr>
        {% endfor %}
      {% endif %}

      <!-- New editable row -->
      {% if not read_only %}
      <tr>
        <td>
          <input type="text" class="form-control form-control-sm workflow-date" 
                 value="{{ today_date }}" placeholder="DD/MM/YYYY" required>
        </td>
        <td>
          <input type="text" class="form-control form-control-sm workflow-user" 
                 value="{{ current_user.username }}" readonly>
        </td>
        <td>
          <select class="form-select form-select-sm workflow-action" required>
            <option value="">Select Action</option>
            {% if activities|length == 0 %}
              <option value="Assembly">Assembly</option>
            {% elif activities|length == 1 %}
              <option value="Testing">Testing</option>
            {% else %}
              <option value="Testing">Testing</option>
              <option value="Testing Report Date">Testing Report Date</option>
            {% endif %}
          </select>
        </td>
        <td>
          <input type="text" class="form-control form-control-sm workflow-remark" 
                 placeholder="Enter remark">
        </td>
        <td class="text-center">
          <button class="btn btn-danger btn-sm" onclick="removeRow(this)">√ó</button>
        </td>
      </tr>
      {% endif %}
    </tbody>
  </table>
</div>

{% if not read_only %}
<button class="btn btn-secondary btn-sm mb-3" onclick="addRow()">+ Add Row</button>
<br>
<button class="btn btn-primary" onclick="saveAll()">üíæ Save Progress</button>

<!-- Boss Final Approve Button -->
{% if is_boss %}
<button class="btn btn-success" onclick="showFinalApproveModal()">‚úì Final Approve</button>
{% endif %}

{% elif pump.status == 'COMPLETED' and is_boss %}
<!-- Boss Reject Button for approved pumps -->
<div class="alert alert-success mt-3">
  <i class="bi bi-check-circle"></i> This pump has been <strong>FINAL APPROVED</strong>
</div>
<button class="btn btn-danger" onclick="showRejectModal()">‚úó Reject & Send Back</button>

{% else %}
<div class="alert alert-info mt-3">
  <i class="bi bi-info-circle"></i> This workflow is in view-only mode. Pump status: <strong>{{ pump.status }}</strong>
</div>
{% endif %}

<a href="{{ url_for('pump_management', pump_id = pump.id) }}" class="btn btn-secondary">‚Üê Back to Pump Form</a>

<!-- Final Approve Modal -->
<div class="modal fade" id="finalApproveModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-success text-white">
        <h5 class="modal-title">Final Approve Pump</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <p>Are you sure you want to <strong>FINAL APPROVE</strong> this pump?</p>
        <p class="text-warning"><i class="bi bi-exclamation-triangle"></i> Once approved, the workflow will be locked.</p>
        
        <div class="mb-3">
          <label for="approveComment" class="form-label">Comment <span class="text-danger">*</span></label>
          <textarea class="form-control" id="approveComment" rows="3" required placeholder="Enter approval comment..."></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-success" onclick="finalApprove()">Approve</button>
      </div>
    </div>
  </div>
</div>

<!-- Reject Modal -->
<div class="modal fade" id="rejectModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title">Reject Pump</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <p>Are you sure you want to <strong>REJECT</strong> this pump?</p>
        <p class="text-info"><i class="bi bi-info-circle"></i> The pump will be sent back to PARTS_APPROVED status for revision.</p>
        
        <div class="mb-3">
          <label for="rejectComment" class="form-label">Rejection Reason <span class="text-danger">*</span></label>
          <textarea class="form-control" id="rejectComment" rows="3" required placeholder="Enter reason for rejection..."></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-danger" onclick="rejectPump()">Reject</button>
      </div>
    </div>
  </div>
</div>

<script>
const pumpId = {{ pump.id }};
const currentUsername = "{{ current_user.username }}";
const totalActivities = {{ activities|length }};
const readOnly = {{ 'true' if read_only else 'false' }}; 

// Get today's date in DD/MM/YYYY format
function getTodayDate() {
  const today = new Date();
  const dd = String(today.getDate()).padStart(2, '0');
  const mm = String(today.getMonth() + 1).padStart(2, '0');
  const yyyy = today.getFullYear();
  return `${dd}/${mm}/${yyyy}`;
}

function addRow() {
  const tbody = document.querySelector('#workflowTable tbody');
  const allRows = tbody.querySelectorAll('tr');
  const editableRows = Array.from(allRows).filter(row => !row.dataset.readonly);
  const totalRows = totalActivities + editableRows.length;

  let actionOptions = '';
  
  if (totalRows === 0) {
    actionOptions = '<option value="">Select Action</option><option value="Assembly">Assembly</option>';
  } else if (totalRows === 1) {
    actionOptions = '<option value="">Select Action</option><option value="Testing">Testing</option>';
  } else {
    actionOptions = `
      <option value="">Select Action</option>
      <option value="Testing">Testing</option>
      <option value="Testing Report Date">Testing Report Date</option>
    `;
  }

  const newRow = `
    <tr>
      <td>
        <input type="text" class="form-control form-control-sm workflow-date" 
               value="${getTodayDate()}" placeholder="DD/MM/YYYY" required>
      </td>
      <td>
        <input type="text" class="form-control form-control-sm workflow-user" 
               value="${currentUsername}" readonly>
      </td>
      <td>
        <select class="form-select form-select-sm workflow-action" required>
          ${actionOptions}
        </select>
      </td>
      <td>
        <input type="text" class="form-control form-control-sm workflow-remark" 
               placeholder="Enter remark">
      </td>
      <td class="text-center">
        <button class="btn btn-danger btn-sm" onclick="removeRow(this)">√ó</button>
      </td>
    </tr>
  `;
  
  tbody.insertAdjacentHTML('beforeend', newRow);
}

function removeRow(btn) {
  const row = btn.closest('tr');
  if (row.dataset.readonly) return;
  row.remove();
}

function validateDate(dateStr) {
  const regex = /^\d{2}\/\d{2}\/\d{4}$/;
  return regex.test(dateStr);
}

function collectRows() {
  const tbody = document.querySelector('#workflowTable tbody');
  const editableRows = tbody.querySelectorAll('tr:not([data-readonly])');
  const rows = [];

  for (let row of editableRows) {
    const date = row.querySelector('.workflow-date').value.trim();
    const action = row.querySelector('.workflow-action').value;
    const remark = row.querySelector('.workflow-remark').value.trim();

    if (!date || !action) {
      showAlert('Please fill all required fields (Date and Action)', 'danger');
      return null;
    }

    if (!validateDate(date)) {
      showAlert('Invalid date format. Use DD/MM/YYYY', 'danger');
      return null;
    }

    rows.push({ date, action, remark });
  }

  return rows;
}

async function saveAll() {
  if (readOnly) {
    showAlert('Cannot save in view-only mode', 'warning');
    return;
  }
  
  const rows = collectRows();
  if (!rows) return;

  if (rows.length === 0) {
    showAlert('No new activities to save', 'warning');
    return;
  }

  try {
    const response = await fetch(`/pumps/${pumpId}/workflow`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ rows })
    });

    const data = await response.json();
    
    if (data.success) {
      showAlert(data.message, 'success');
      setTimeout(() => location.reload(), 1000);
    } else {
      showAlert(data.message || 'Failed to save', 'danger');
    }
  } catch (error) {
    showAlert('Error saving workflow: ' + error.message, 'danger');
  }
}

function showFinalApproveModal() {
  const modal = new bootstrap.Modal(document.getElementById('finalApproveModal'));
  document.getElementById('approveComment').value = '';
  modal.show();
}

async function finalApprove() {
  const comment = document.getElementById('approveComment').value.trim();
  
  if (!comment) {
    alert('Please enter a comment');
    return;
  }

  try {
    const response = await fetch(`/pumps/${pumpId}/workflow/final-approve`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ comment })
    });

    const data = await response.json();
    
    if (data.success) {
      showAlert(data.message, 'success');
      setTimeout(() => location.reload(), 1500);
    } else {
      showAlert(data.message || 'Failed to approve', 'danger');
    }
  } catch (error) {
    showAlert('Error approving: ' + error.message, 'danger');
  }
}

function showRejectModal() {
  const modal = new bootstrap.Modal(document.getElementById('rejectModal'));
  document.getElementById('rejectComment').value = '';
  modal.show();
}

async function rejectPump() {
  const comment = document.getElementById('rejectComment').value.trim();
  
  if (!comment) {
    alert('Please enter a rejection reason');
    return;
  }

  try {
    const response = await fetch(`/pumps/${pumpId}/workflow/reject`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ comment })
    });

    const data = await response.json();
    
    if (data.success) {
      showAlert(data.message, 'success');
      setTimeout(() => location.reload(), 1500);
    } else {
      showAlert(data.message || 'Failed to reject', 'danger');
    }
  } catch (error) {
    showAlert('Error rejecting: ' + error.message, 'danger');
  }
}

function showAlert(message, type) {
  const alertBox = document.getElementById('alertBox');
  alertBox.className = `alert alert-${type}`;
  alertBox.textContent = message;
  alertBox.classList.remove('d-none');
  
  setTimeout(() => {
    alertBox.classList.add('d-none');
  }, 5000);
}
</script>

{% endblock %}